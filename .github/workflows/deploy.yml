name: Deploy to Synology

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_build:
        description: '빌드 없이 재시작만 (코드 변경 없을 때)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 20m
          script: |
            set -e
            export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
            cd /volume1/docker

            echo "=========================================="
            echo "  Printing114 배포 시작"
            echo "  시각: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # 1. Git Fetch & Reset
            echo ""
            echo "=== [1/6] Git Fetch & Reset ==="
            git fetch origin main
            git reset --hard origin/main
            echo "현재 커밋: $(git log --oneline -1)"

            # 2. 네트워크 & DB 사전 점검
            echo ""
            echo "=== [2/6] 네트워크 & DB 점검 ==="
            # 네트워크가 없으면 생성
            sudo docker network create photocafe-network 2>/dev/null && echo "네트워크 생성됨" || echo "네트워크 이미 존재"
            # DB 컨테이너가 해당 네트워크에 연결되어 있는지 확인
            if sudo docker inspect photocafe-db > /dev/null 2>&1; then
              sudo docker network connect --alias postgres photocafe-network photocafe-db 2>/dev/null && echo "DB를 네트워크에 연결" || echo "DB 이미 네트워크에 연결됨"
              echo "DB 상태: $(sudo docker inspect --format='{{.State.Status}}' photocafe-db)"
            else
              echo "경고: photocafe-db 컨테이너가 없습니다. DB를 먼저 시작하세요."
              exit 1
            fi

            # 3. Docker 빌드 & 재시작 (DB 제외, api/web만)
            echo ""
            if [ "${{ inputs.skip_build }}" = "true" ]; then
              echo "=== [3/6] Docker 재시작 (빌드 스킵) ==="
              sudo /usr/local/bin/docker-compose -f docker-compose.prod.yml restart api web
            else
              echo "=== [3/6] Docker 빌드 & 재시작 (api + web only) ==="
              sudo docker builder prune -f --filter "until=24h" 2>/dev/null || true
              # 기존 컨테이너 충돌 방지: 먼저 중지 후 제거
              sudo /usr/local/bin/docker-compose -f docker-compose.prod.yml stop api web 2>/dev/null || true
              sudo /usr/local/bin/docker-compose -f docker-compose.prod.yml rm -f api web 2>/dev/null || true
              sudo /usr/local/bin/docker-compose -f docker-compose.prod.yml up -d --build --no-deps api web
            fi

            # 4. 시작 대기
            echo ""
            echo "=== [4/6] 서버 시작 대기 ==="
            for i in $(seq 1 24); do
              sleep 5
              if curl -sf http://localhost:3001/health > /dev/null 2>&1; then
                echo "API 서버 준비 완료! ($((i*5))초)"
                break
              fi
              echo "대기 중... ($((i*5))초)"
              if [ "$i" = "24" ]; then
                echo "API 시작 타임아웃 (120초). 로그 확인:"
                sudo /usr/local/bin/docker logs photocafe-api --tail 30
                exit 1
              fi
            done

            # 5. 컨테이너 상태
            echo ""
            echo "=== [5/6] 컨테이너 상태 ==="
            sudo /usr/local/bin/docker ps --filter 'name=photocafe' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'

            # 6. Health Check
            echo ""
            echo "=== [6/6] Health Check ==="
            API_HEALTH=$(curl -sf http://localhost:3001/health 2>&1) && {
              echo "API: OK"
              echo "$API_HEALTH"
            } || {
              echo "API: FAILED"
              echo "최근 로그:"
              sudo /usr/local/bin/docker logs photocafe-api --tail 30
              exit 1
            }

            echo ""
            echo "=========================================="
            echo "  배포 완료! $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip build**: ${{ inputs.skip_build }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- API: http://1.212.201.147:3001" >> $GITHUB_STEP_SUMMARY
          echo "- WEB: http://1.212.201.147:3000" >> $GITHUB_STEP_SUMMARY
          echo "- Swagger: http://1.212.201.147:3001/api/docs" >> $GITHUB_STEP_SUMMARY
