// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 사용자 및 인증 ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("staff") // admin, manager, staff
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// 시스템 설정 (무료배송 금액 등)
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique  // 설정 키 (예: free_shipping_threshold)
  value     String            // 설정 값
  category  String            // 카테고리 (shipping, payment, etc.)
  label     String?           // 표시 라벨
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_settings")
}


// ==================== 직원관리 ====================

// 부서
model Department {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  staff Staff[]

  @@map("departments")
}

// 직원
model Staff {
  id            String   @id @default(cuid())
  staffId       String   @unique  // 직원 ID (로그인용)
  password      String            // 비밀번호 (해시)
  name          String            // 실명

  // 소속 정보
  branchId      String?           // 소속 지점
  branch        Branch?  @relation(fields: [branchId], references: [id])
  departmentId  String?           // 부서
  department    Department? @relation(fields: [departmentId], references: [id])
  position      String?           // 직책

  // 연락처 정보
  phone         String?           // 전화번호
  mobile        String?           // 휴대폰
  email         String?           // 이메일

  // 주소 정보
  postalCode    String?
  address       String?
  addressDetail String?

  // 정산 등급 (0등급은 정산이 되지 않는 등급)
  settlementGrade Int      @default(1)  // 1~15등급

  // 접근 IP 제한
  allowedIps    String[] @default([])  // 허용된 IP 목록

  // View 권한 설정
  canEditInManagerView  Boolean  @default(false)  // 체크시 관리자 화면에서 수정가능

  // 접근 권한 설정
  canLoginAsManager     Boolean  @default(false)  // 체크시 관리자 로그인 허용

  // 단계변경 권한
  canChangeDepositStage     Boolean  @default(false)  // 입금대기 주문건에 대해 단계변경 가능
  canChangeReceptionStage   Boolean  @default(false)  // 접수대기 주문건에 대해 단계변경 가능
  canChangeCancelStage      Boolean  @default(false)  // 주문취소 주문건에 대해 단계변경 가능

  // 버튼 노출 권한
  canEditMemberInfo     Boolean  @default(false)  // 회원수정 버튼 노출
  canViewSettlement     Boolean  @default(false)  // 정산마감 버튼 노출
  canChangeOrderAmount  Boolean  @default(false)  // 주문금액변경 버튼 노출

  // 담당 회원 조회 범위
  memberViewScope       String   @default("own")   // own: 본인담당만, all: 전체

  // 매출 조회 범위
  salesViewScope        String   @default("own")   // own: 본인거래처만, all: 전체

  // 메뉴/카테고리별 접근 권한 (JSON)
  menuPermissions       Json?    // 메뉴별 접근 권한
  categoryPermissions   Json?    // 카테고리별 접근 권한

  // 공정별 권한 (JSON 형태로 저장)
  // { processCode: { view: true, edit: false, delete: false }, ... }
  processPermissions    Json?

  // 상태
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  lastLoginIp   String?

  // 메모
  adminMemo     String?  @db.Text  // 최고 관리자 메모

  // 입사일
  joinDate      DateTime @default(now())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 담당 회원 (거래처)
  assignedClients StaffClient[]

  @@index([branchId])
  @@index([departmentId])
  @@index([isActive])
  @@map("staff")
}

// 직원-회원(거래처) 담당 매핑
model StaffClient {
  id        String   @id @default(cuid())
  staffId   String
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  isPrimary Boolean  @default(false)  // 주담당자 여부
  createdAt DateTime @default(now())

  @@unique([staffId, clientId])
  @@index([staffId])
  @@index([clientId])
  @@map("staff_clients")
}

// 메뉴 권한 템플릿 (편의를 위한 권한 그룹)
model PermissionTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?

  // 권한 설정 (JSON)
  permissions Json     // { menus: [], categories: [], processes: [] }

  isDefault   Boolean  @default(false)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permission_templates")
}

// ==================== 회사정보 ====================

model Branch {
  id             String        @id @default(cuid())
  branchCode     String        @unique
  branchName     String
  isHeadquarters Boolean       @default(false)
  address        String?
  phone          String?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  clientGroups ClientGroup[]
  staff        Staff[]

  @@map("branches")
}

model ClientGroup {
  id               String   @id @default(cuid())
  groupCode        String   @unique
  groupName        String
  branchId         String
  branch           Branch   @relation(fields: [branchId], references: [id])

  // 품목별 할인율 (100 = 정가)
  generalDiscount  Int      @default(100)
  premiumDiscount  Int      @default(100)
  importedDiscount Int      @default(100)

  description      String?  @db.Text
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  clients              Client[]
  halfProductPrices    GroupHalfProductPrice[]
  productPrices        GroupProductPrice[]

  @@index([branchId])
  @@map("client_groups")
}

model Client {
  id              String       @id @default(cuid())
  clientCode      String       @unique
  clientName      String
  businessNumber  String?
  representative  String?

  phone           String?
  mobile          String?
  email           String?
  password        String?      // 일반 가입 시 비밀번호 (해시)

  postalCode      String?
  address         String?
  addressDetail   String?

  groupId         String?
  group           ClientGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  // 회원 타입: individual(개인), business(사업자)
  memberType      String       @default("individual")
  
  // OAuth 정보
  oauthProvider   String?      // google, naver, kakao
  oauthId         String?      // OAuth 고유 ID
  
  // 가격 적용: standard(표준단가-개인), group(그룹단가-사업자)
  priceType       String       @default("standard")

  // 결제 방식: order(주문시결제), credit(신용거래)
  paymentType     String       @default("order")
  
  // 신용거래 설정 (관리자만 수정 가능)
  creditEnabled      Boolean   @default(false)  // 신용거래 허용 여부
  creditPeriodDays   Int?                       // 신용거래 기간 (일)
  creditPaymentDay   Int?                       // 결제일 (매월 N일)
  creditBlocked      Boolean   @default(false)  // 미입금으로 인한 주문 차단
  creditBlockedAt    DateTime?                  // 차단 시점
  lastPaymentDate    DateTime?                  // 마지막 결제일
  
  // 배송 설정 (관리자만 수정 가능): conditional(조건부), free(무료), prepaid(선불), cod(착불)
  shippingType       String    @default("conditional")

  creditGrade     String       @default("B") // A, B, C, D
  paymentTerms    Int          @default(30)
  status          String       @default("active") // active, inactive, suspended

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  orders       Order[]
  myProducts   MyProduct[]
  assignedStaff StaffClient[]

  @@unique([oauthProvider, oauthId])
  @@index([groupId])
  @@index([clientCode])
  @@index([memberType])
  @@index([oauthProvider])
  @@map("clients")
}


// ==================== 규격정보 ====================

model Specification {
  id          String   @id @default(cuid())
  code        String   @unique     // 고유 코드 (자동 생성)
  name        String               // 규격명 (예: "7x4.7", "22.5x30.5")

  // 크기 정보
  widthInch   Decimal  @db.Decimal(10, 4)  // 가로 (인치)
  heightInch  Decimal  @db.Decimal(10, 4)  // 세로 (인치)
  widthMm     Decimal  @db.Decimal(10, 2)  // 가로 (mm)
  heightMm    Decimal  @db.Decimal(10, 2)  // 세로 (mm)

  // 방향 (가로형/세로형/정방형)
  orientation String   @default("landscape")  // landscape: 가로형, portrait: 세로형, square: 정방형
  pairId      String?  // 쌍이 되는 규격의 ID (가로형 <-> 세로형)

  // 용도 체크박스 (중첩 사용 가능)
  forIndigo   Boolean  @default(false)  // 인디고출력전용
  forInkjet   Boolean  @default(false)  // 잉크젯출력전용
  forAlbum    Boolean  @default(false)  // 앨범전용
  forFrame    Boolean  @default(false)  // 액자전용
  forBooklet  Boolean  @default(false)  // 인쇄책자전용

  // 추가 정보
  squareMeters  Decimal?  @db.Decimal(10, 2)  // 평방미터 (㎡)
  description   String?   // 설명

  // Nup 설정 (앨범 전용)
  nup           String?   // "1++up" | "1+up" | "1up" | "2up" | "4up" (앨범 체크시 자동계산)
  nupSqInch     Decimal?  @db.Decimal(10, 2)  // 계산된 면적 (sq inch = widthInch * heightInch)

  // 정렬 및 상태
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  prices              SpecificationPrice[]
  productionSettings  ProductionSettingSpecification[]

  @@index([isActive])
  @@index([forIndigo])
  @@index([forInkjet])
  @@index([forAlbum])
  @@index([forFrame])
  @@index([forBooklet])
  @@index([orientation])
  @@index([pairId])
  @@map("specifications")
}

model SpecificationPrice {
  id              String        @id @default(cuid())
  specificationId String
  specification   Specification @relation(fields: [specificationId], references: [id], onDelete: Cascade)
  
  // 가격 타입 (예: 기본가, 그룹별 가격 등)
  priceType       String        @default("base")  // base, group
  groupId         String?       // 그룹 가격인 경우
  
  price           Decimal       @db.Decimal(12, 2)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([specificationId, priceType, groupId])
  @@map("specification_prices")
}

// ==================== 매출품목 분류 ====================

model SalesCategoryOption {
  id          String   @id @default(cuid())
  code        String   @unique  // 고유 코드 (예: album, print, etc.)
  name        String             // 표시 이름 (예: 앨범, 출력물, etc.)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@map("sales_category_options")
}

// 매출품목분류 (2단계 계층)
model SalesCategory {
  id          String   @id @default(cuid())
  code        String   @unique     // 고유 코드
  name        String               // 분류명
  depth       Int      @default(1) // 1: 대분류, 2: 소분류

  // 계층 구조
  parentId    String?
  parent      SalesCategory?  @relation("SalesCategoryTree", fields: [parentId], references: [id])
  children    SalesCategory[] @relation("SalesCategoryTree")

  // 정렬 및 상태
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
  @@index([isActive])
  @@map("sales_categories")
}

// ==================== 카테고리 ====================

model Category {
  id              String     @id @default(cuid())
  code            String?    @unique    // 8자리 코드: 65000000
  name            String
  level           String     // large, medium, small
  depth           Int        @default(1) // 1: 대분류, 2: 중분류, 3: 소분류

  // 계층 구조
  parentId        String?
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")

  // 노출 설정
  isVisible       Boolean    @default(true)  // 노출/숨김
  isTopMenu       Boolean    @default(false) // 상단메뉴 노출
  loginVisibility String     @default("always") // always, logged_in, logged_out

  // 카테고리 타입
  categoryType    String     @default("HTML") // HTML, POD, EDITOR, HALF, production

  // 생산 설정
  productionForm  String?    // 생산폼 옵션 (digital_print, output_only, album_only, frame_only, goods_only)
  isOutsourced    Boolean    @default(false) // 외주생산 여부

  // 가격 적용 단위 (production 카테고리용)
  pricingUnit     String?    // paper_based: 용지별출력단가, size_based: 규격별출력단가(page/장), per_item: 권당단가

  // 설명
  description     String?    // 카테고리 설명

  // 이동경로 (링크)
  linkUrl         String?    // 커스텀 링크 URL

  // 콘텐츠
  htmlContent     String?    @db.Text // HTML 내용

  // 정렬 및 상태
  sortOrder       Int        @default(0)
  isActive        Boolean    @default(true)

  // 카테고리 아이콘
  iconUrl         String?    // 카테고리 앞에 표시되는 작은 이미지 URL
  
  // 매출품목 분류 ID
  salesCategoryId String?    // SalesCategory 참조 ID

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  products        Product[]
  halfProducts    HalfProduct[]

  @@index([parentId])
  @@index([categoryType])
  @@index([isTopMenu])
  @@map("categories")
}

// ==================== 상품관리 ====================

model Product {
  id           String   @id @default(cuid())
  productCode  String   @unique
  productName  String
  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id])

  isActive     Boolean  @default(true)
  isNew        Boolean  @default(false)
  isBest       Boolean  @default(false)
  memberType   String   @default("all") // all, member_only, specific_groups

  basePrice    Decimal  @db.Decimal(12, 2)
  thumbnailUrl String?
  detailImages String[] @default([])
  description  String?  @db.Text

  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  specifications ProductSpecification[]
  bindings       ProductBinding[]
  papers         ProductPaper[]
  covers         ProductCover[]
  foils          ProductFoil[]
  finishings     ProductFinishing[]
  customOptions  CustomOption[]
  halfProducts   ProductHalfProduct[]
  groupPrices    GroupProductPrice[]

  @@index([categoryId])
  @@map("products")
}

model ProductSpecification {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String  // 규격명
  widthMm   Float
  heightMm  Float
  price     Decimal @db.Decimal(10, 2) @default(0)
  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  @@index([productId])
  @@map("product_specifications")
}

model ProductBinding {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String  // 제본방법명
  price     Decimal @db.Decimal(10, 2) @default(0)
  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  @@index([productId])
  @@map("product_bindings")
}

model ProductPaper {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String  // 용지명
  type      String  // normal, premium, imported
  price     Decimal @db.Decimal(10, 2) @default(0)
  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  @@index([productId])
  @@map("product_papers")
}

model ProductCover {
  id           String  @id @default(cuid())
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name         String  // 커버명
  materialCode String?
  price        Decimal @db.Decimal(10, 2) @default(0)
  imageUrl     String?
  isDefault    Boolean @default(false)
  sortOrder    Int     @default(0)

  @@index([productId])
  @@map("product_covers")
}

model ProductFoil {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String  // 박명
  color     String? // 박색상
  price     Decimal @db.Decimal(10, 2) @default(0)
  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  @@index([productId])
  @@map("product_foils")
}

model ProductFinishing {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String  // 후가공명
  price     Decimal @db.Decimal(10, 2) @default(0)
  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  @@index([productId])
  @@map("product_finishings")
}

model CustomOption {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String  // 옵션명
  type      String  // select, checkbox, input
  values    Json?   // 선택지 목록
  price     Decimal @db.Decimal(10, 2) @default(0)
  isRequired Boolean @default(false)
  sortOrder Int     @default(0)

  @@index([productId])
  @@map("custom_options")
}

model ProductHalfProduct {
  id            String      @id @default(cuid())
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  halfProductId String
  halfProduct   HalfProduct @relation(fields: [halfProductId], references: [id], onDelete: Cascade)
  isRequired    Boolean     @default(false)
  sortOrder     Int         @default(0)

  @@unique([productId, halfProductId])
  @@map("product_half_products")
}

// ==================== 반제품 ====================

model HalfProduct {
  id                String   @id @default(cuid())
  code              String   @unique
  name              String

  categoryLargeId   String
  categoryLarge     Category @relation(fields: [categoryLargeId], references: [id])

  basePrice         Decimal  @db.Decimal(12, 2)
  isPriceAdditive   Boolean  @default(true)
  memberType        String   @default("all")
  requiredFileCount Int      @default(0)

  thumbnailUrl      String?
  detailImages      String[] @default([])

  status            String   @default("active")
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  specifications HalfProductSpecification[]
  priceTiers     HalfProductPriceTier[]
  options        HalfProductOption[]
  productLinks   ProductHalfProduct[]
  groupPrices    GroupHalfProductPrice[]

  @@index([categoryLargeId])
  @@map("half_products")
}

model HalfProductSpecification {
  id            String      @id @default(cuid())
  halfProductId String
  halfProduct   HalfProduct @relation(fields: [halfProductId], references: [id], onDelete: Cascade)
  name          String
  widthMm       Float
  heightMm      Float
  price         Decimal     @db.Decimal(10, 2) @default(0)
  isDefault     Boolean     @default(false)
  sortOrder     Int         @default(0)

  @@index([halfProductId])
  @@map("half_product_specifications")
}

model HalfProductPriceTier {
  id            String      @id @default(cuid())
  halfProductId String
  halfProduct   HalfProduct @relation(fields: [halfProductId], references: [id], onDelete: Cascade)
  minQuantity   Int
  maxQuantity   Int?
  discountRate  Float       // 할인율 (1.0 = 정가)
  sortOrder     Int         @default(0)

  @@index([halfProductId])
  @@map("half_product_price_tiers")
}

model HalfProductOption {
  id            String      @id @default(cuid())
  halfProductId String
  halfProduct   HalfProduct @relation(fields: [halfProductId], references: [id], onDelete: Cascade)
  name          String
  type          String      // select, checkbox
  values        Json        // [{name, price, isDefault}]
  quantityType  String      @default("auto") // auto, manual
  sortOrder     Int         @default(0)

  @@index([halfProductId])
  @@map("half_product_options")
}

// ==================== 가격관리 ====================

model GroupHalfProductPrice {
  id            String      @id @default(cuid())
  groupId       String
  group         ClientGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  halfProductId String
  halfProduct   HalfProduct @relation(fields: [halfProductId], references: [id], onDelete: Cascade)
  price         Decimal     @db.Decimal(12, 2)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([groupId, halfProductId])
  @@map("group_half_product_prices")
}

model GroupProductPrice {
  id        String      @id @default(cuid())
  groupId   String
  group     ClientGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  productId String
  product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  price     Decimal     @db.Decimal(12, 2)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([groupId, productId])
  @@map("group_product_prices")
}

// ==================== My상품 ====================

model MyProduct {
  id               String    @id @default(cuid())
  clientId         String
  client           Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  productType      String    // product, half_product
  productId        String

  customName       String?
  customThumbnail  String?

  registrationType String    // customer, admin
  registeredBy     String

  defaultOptions   Json?

  sortOrder        Int       @default(0)
  isActive         Boolean   @default(true)
  usageCount       Int       @default(0)
  lastUsedAt       DateTime?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([clientId, productType, productId])
  @@index([clientId])
  @@map("my_products")
}

// ==================== 주문관리 ====================

model Order {
  id                    String    @id @default(cuid())
  orderNumber           String    @unique
  barcode               String    @unique

  clientId              String
  client                Client    @relation(fields: [clientId], references: [id])

  productPrice          Decimal   @db.Decimal(12, 2)
  shippingFee           Decimal   @db.Decimal(10, 2) @default(0)
  tax                   Decimal   @db.Decimal(10, 2) @default(0)
  adjustmentAmount      Decimal   @db.Decimal(10, 2) @default(0)
  totalAmount           Decimal   @db.Decimal(12, 2)
  finalAmount           Decimal   @db.Decimal(12, 2)

  paymentMethod         String    @default("postpaid") // prepaid, postpaid, card, transfer
  paymentStatus         String    @default("pending") // pending, paid, partial, refunded

  status                String    @default("pending_receipt")
  currentProcess        String    @default("receipt_pending")

  isUrgent              Boolean   @default(false)
  requestedDeliveryDate DateTime?

  customerMemo          String?   @db.Text
  productMemo           String?   @db.Text
  adminMemo             String?   @db.Text

  orderedAt             DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  shipping       OrderShipping?
  items          OrderItem[]
  processHistory ProcessHistory[]

  @@index([clientId])
  @@index([status])
  @@index([orderedAt])
  @@map("orders")
}

model OrderShipping {
  id            String  @id @default(cuid())
  orderId       String  @unique
  order         Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  recipientName String
  phone         String
  postalCode    String
  address       String
  addressDetail String?

  courierCode   String?
  trackingNumber String?
  shippedAt     DateTime?
  deliveredAt   DateTime?

  @@map("order_shippings")
}

model OrderItem {
  id               String  @id @default(cuid())
  orderId          String
  order            Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productionNumber String
  productId        String
  productName      String

  size             String
  pages            Int
  printMethod      String
  paper            String
  bindingType      String
  coverMaterial    String?
  foilName         String?
  foilColor        String?
  finishingOptions String[] @default([])

  quantity         Int
  unitPrice        Decimal  @db.Decimal(10, 2)
  totalPrice       Decimal  @db.Decimal(12, 2)

  files OrderFile[]

  @@index([orderId])
  @@map("order_items")
}

model OrderFile {
  id               String    @id @default(cuid())
  orderItemId      String
  orderItem        OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  fileName         String
  fileUrl          String
  thumbnailUrl     String?

  pageRange        String
  pageStart        Int
  pageEnd          Int

  width            Int
  height           Int
  widthInch        Float
  heightInch       Float
  dpi              Int
  fileSize         Int

  inspectionStatus String    @default("pending") // pending, passed, failed
  inspectionNote   String?

  sortOrder        Int       @default(0)
  uploadedAt       DateTime  @default(now())

  @@index([orderItemId])
  @@map("order_files")
}

model ProcessHistory {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  fromStatus  String?
  toStatus    String
  processType String

  note        String?
  processedBy String
  processedAt DateTime @default(now())

  @@index([orderId])
  @@map("process_histories")
}

// ==================== 접수 마감 관리 ====================

model ReceptionSchedule {
  id          String    @id @default(cuid())
  date        DateTime  @db.Date
  year        Int
  month       Int
  day         Int
  dayOfWeek   Int

  status      String    @default("open") // open, closed, early_close, holiday, limited
  openTime    String?
  closeTime   String?

  reason      String?
  reasonType  String?   // regular_holiday, public_holiday, special, other

  isHoliday   Boolean   @default(false)
  holidayName String?

  modifiedBy  String?
  modifiedAt  DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([year, month, day])
  @@index([year, month])
  @@index([status])
  @@map("reception_schedules")
}

model RegularHolidaySetting {
  id            String   @id @default(cuid())
  type          String   // weekly, monthly, yearly
  weeklyDays    Int[]    @default([]) // [0, 6] = 일요일, 토요일
  monthlyDays   Int[]    @default([])
  yearlyDates   String[] @default([]) // ['01-01', '12-25']

  effectiveFrom DateTime
  effectiveTo   DateTime?
  name          String
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("regular_holiday_settings")
}

// ==================== 용지 관리 ====================

// 용지 그룹 (Paper Group) - 컬러로 구분되는 용지 그룹, 그룹단가 설정
model PaperGroup {
  id          String   @id @default(cuid())
  code        String   @unique     // 고유 코드
  name        String               // 그룹명 (예: 광택지, 무광지, 특수지)
  color       String               // 그룹 구분 색상 (green, blue, yellow, red, purple 등)

  // 그룹 기본 단가 (연당)
  basePrice   Decimal  @db.Decimal(12, 2) @default(0)  // 그룹 기본 단가
  unitType    String   @default("ream")                // sheet, roll, ream, sqm

  description String?  @db.Text    // 설명

  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  papers      Paper[]

  @@index([isActive])
  @@index([color])
  @@map("paper_groups")
}

// 용지대리점 (Paper Supplier/Dealer)
model PaperSupplier {
  id          String   @id @default(cuid())
  code        String   @unique     // 고유 코드
  name        String               // 대리점명
  phone       String?              // 전화번호
  mobile      String?              // 휴대폰
  email       String?              // 이메일
  fax         String?              // 팩스
  postalCode  String?              // 우편번호
  address     String?              // 주소
  addressDetail String?            // 상세주소
  representative String?           // 담당자명
  website     String?              // 웹사이트
  description String?  @db.Text    // 설명
  memo        String?  @db.Text    // 관리자 메모

  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  papers      Paper[]

  @@index([isActive])
  @@map("paper_suppliers")
}

// 제지사 (Paper Manufacturer)
model PaperManufacturer {
  id          String   @id @default(cuid())
  code        String   @unique     // 고유 코드
  name        String               // 제지사명 (예: 신호제지, 한솔제지, 미래엔페이퍼)
  country     String?              // 국가
  website     String?              // 웹사이트
  contactInfo String?              // 연락처 정보
  description String?  @db.Text    // 설명

  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  papers      Paper[]

  @@index([isActive])
  @@map("paper_manufacturers")
}

// 용지 (Paper)
model Paper {
  id              String            @id @default(cuid())
  code            String            @unique     // 고유 코드
  name            String                        // 용지명

  // 용지 그룹 연결
  paperGroupId    String?
  paperGroup      PaperGroup?       @relation(fields: [paperGroupId], references: [id], onDelete: SetNull)

  // 제지사 연결
  manufacturerId  String?
  manufacturer    PaperManufacturer? @relation(fields: [manufacturerId], references: [id], onDelete: SetNull)

  // 용지대리점 연결
  supplierId      String?
  supplier        PaperSupplier?    @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  // 용지 구분
  paperType       String            @default("sheet")  // roll: 롤지, sheet: 시트지

  // 용지 규격 (시트지인 경우)
  sheetSize       String?           // 국전지(788x1091), 46전지(788x545) 등
  sheetWidthMm    Decimal?          @db.Decimal(10, 2)  // 낱장 가로 (mm)
  sheetHeightMm   Decimal?          @db.Decimal(10, 2)  // 낱장 세로 (mm)
  customSheetName String?           // 별사이즈 규격명 (custom 선택시)

  // 롤 용지 규격 (롤지인 경우)
  rollWidth       String?           // 17", 24", 32", 36", 44", 48" 등
  rollWidthInch   Decimal?          @db.Decimal(10, 2)  // 롤 폭 (인치)
  rollLength      String?           // 30m, 40m, 50m 등
  rollLengthM     Decimal?          @db.Decimal(10, 2)  // 롤 길이 (미터)

  // 용지 평량
  grammage        Int?              // 평량 (g/m²) - 예: 210, 250
  grammageDisplay String?           // 표시용 (예: "210g/m²")

  // 표면 질감 (Finish)
  finish          String?           @default("matte")  // glossy: 광택, matte: 무광, lustre: 반광, canvas: 캔버스, satin: 새틴
  finishDisplay   String?           // 표시용 (예: "Glossy(광택)")

  // 출력 방식 연결 (멀티 선택 가능)
  printMethods    String[]          @default([])  // indigo: 인디고출력, inkjet: 잉크젯출력, offset: 오프셋

  // 색상 정보
  colorType       String?           // white: 백색, ivory: 아이보리, cream: 크림, etc.
  colorGroup      String?           // 용지 그룹핑용 (예: "green", "blue", "yellow", "red")

  // 두께 정보
  thickness       Decimal?          @db.Decimal(10, 3)  // 두께 (mm)

  // 가격 정보
  basePrice       Decimal           @db.Decimal(12, 2) @default(0)  // 기본 단가
  unitType        String            @default("sheet")  // sheet: 장당, roll: 롤당, sqm: 제곱미터당

  // 할인 정보
  discountRate    Decimal           @db.Decimal(5, 2) @default(0)   // 할인율 (%)
  discountPrice   Decimal?          @db.Decimal(12, 2)              // 할인가

  // 재고 관련
  stockQuantity   Int               @default(0)        // 재고 수량
  minStockLevel   Int               @default(0)        // 최소 재고 수준

  // 추가 정보
  description     String?           @db.Text           // 설명
  memo            String?           @db.Text           // 관리자 메모

  // 정렬 및 상태
  sortOrder       Int               @default(0)
  isActive        Boolean           @default(true)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  prices          PaperPrice[]

  @@index([paperGroupId])
  @@index([manufacturerId])
  @@index([supplierId])
  @@index([paperType])
  @@index([isActive])
  @@map("papers")
}

// 용지 가격 (그룹별/수량별 가격)
model PaperPrice {
  id          String   @id @default(cuid())
  paperId     String
  paper       Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)

  // 가격 타입
  priceType   String   @default("base")  // base: 기본가, group: 그룹가, quantity: 수량별
  groupId     String?                    // 그룹 가격인 경우

  // 수량 조건
  minQuantity Int?                       // 최소 수량
  maxQuantity Int?                       // 최대 수량

  // 가격
  price       Decimal  @db.Decimal(12, 2)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([paperId])
  @@index([priceType])
  @@map("paper_prices")
}

// ==================== 카테고리별 생산설정 (표준단가) ====================

// 생산설정 그룹 (2단계: 대분류 > 소분류)
model ProductionGroup {
  id          String   @id @default(cuid())
  code        String   @unique     // 고유 코드 (예: 0101, 010106)
  name        String               // 그룹명 (예: 출력전용, 포토북)
  depth       Int      @default(1) // 1: 대분류, 2: 소분류

  // 계층 구조
  parentId    String?
  parent      ProductionGroup?  @relation("ProductionGroupTree", fields: [parentId], references: [id])
  children    ProductionGroup[] @relation("ProductionGroupTree")

  // 정렬 및 상태
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  settings    ProductionSetting[]

  @@index([parentId])
  @@index([isActive])
  @@map("production_groups")
}

// 카테고리별 생산설정 (소분류에만 연결)
model ProductionSetting {
  id              String          @id @default(cuid())
  groupId         String
  group           ProductionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // 코드명 (선택적)
  codeName        String?

  // 업체명 (본사, 외주 등)
  vendorType      String          @default("in_house") // in_house: 본사, outsourced: 외주

  // 가격 적용 단위
  // paper_output_spec: [1.출력전용] 용지별출력단가/규격별 (인쇄방식+규격)
  // indigo_spec: [1.출력전용] 인디고규격별 단가
  // nup_page_range: [2.제본전용] 구간별 Nup+면당가격
  // per_sheet: 장당가격 (규격입력안함)
  pricingType     String          @default("paper_output_spec")

  // 세팅명 (박Color 등 추가 설정명)
  settingName     String?

  // S코드 (추가 코드)
  sCode           String?

  // 잡세팅비 / 기본단가
  settingFee      Decimal         @db.Decimal(12, 2) @default(0)  // 잡세팅비
  basePrice       Decimal         @db.Decimal(12, 2) @default(0)  // 기본단가

  // 작업시간 (일 단위, 소수점 1자리까지)
  workDays        Decimal         @db.Decimal(5, 1)  @default(0)

  // 가중치 구분 정보 (텍스트로 저장, 예: "1\n2\n3")
  weightInfo      String?         @db.Text

  // 용지별 출력단가 설정
  printMethod     String?         // indigo, inkjet
  paperIds        String[]        @default([]) // 선택된 용지 ID 목록

  // 양면/단면 가격
  singleSidedPrice  Decimal?      @db.Decimal(12, 2) // 단면 단가
  doubleSidedPrice  Decimal?      @db.Decimal(12, 2) // 양면 단가

  // 잉크젯 기준규격 설정 (sq inch 가격 계산용)
  baseSpecificationId String?     // 기준규격 ID
  basePricePerSqInch  Decimal?    @db.Decimal(12, 6) // sq inch당 기준가격 (자동 계산됨)

  // 용지 단가 그룹 설정 (인디고용)
  // priceGroups: [{ id, color, upPrices: [{ up, weight, fourColorSinglePrice, ... }] }]
  priceGroups         Json?       // 단가 그룹 배열 (최대 5개)
  // paperPriceGroupMap: { paperId: priceGroupId | null }
  paperPriceGroupMap  Json?       // 용지별 그룹 할당 맵

  // 구간별 Nup+면당가격 페이지 구간 설정
  pageRanges          Json?       // 페이지 구간 배열 (예: [30, 40, 50, 60])

  // 정렬 및 상태
  sortOrder       Int             @default(0)
  isActive        Boolean         @default(true)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  specifications  ProductionSettingSpecification[]
  prices          ProductionSettingPrice[]

  @@index([groupId])
  @@index([pricingType])
  @@map("production_settings")
}

// 생산설정-규격 연결 (선택된 규격들)
model ProductionSettingSpecification {
  id                  String            @id @default(cuid())
  productionSettingId String
  productionSetting   ProductionSetting @relation(fields: [productionSettingId], references: [id], onDelete: Cascade)
  specificationId     String
  specification       Specification     @relation(fields: [specificationId], references: [id], onDelete: Cascade)

  // 규격별 가격 (선택적 - 설정 안하면 기본가 사용)
  price               Decimal?          @db.Decimal(12, 2)

  sortOrder           Int               @default(0)

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([productionSettingId, specificationId])
  @@map("production_setting_specifications")
}

// 생산설정 가격표 (수량별/페이지별/Up별 가격)
model ProductionSettingPrice {
  id                  String            @id @default(cuid())
  productionSettingId String
  productionSetting   ProductionSetting @relation(fields: [productionSettingId], references: [id], onDelete: Cascade)

  // 가격 조건
  specificationId     String?           // 규격별 가격인 경우
  minQuantity         Int?              // 최소 수량 (수량별 가격인 경우) / Up값 (인디고)
  maxQuantity         Int?              // 최대 수량

  // 가중치 (Up별 가격 계산용)
  weight              Decimal?          @db.Decimal(5, 2)

  // 가격 (단면/양면) - 기존 호환용
  price               Decimal           @db.Decimal(12, 2) @default(0)  // 기존 호환용 (단면)
  singleSidedPrice    Decimal?          @db.Decimal(12, 2) // 단면 단가 (기존 호환용)
  doubleSidedPrice    Decimal?          @db.Decimal(12, 2) // 양면 단가 (기존 호환용)

  // 인디고 4도칼라 가격
  fourColorSinglePrice   Decimal?       @db.Decimal(12, 2) // 4도칼라 단면 단가
  fourColorDoublePrice   Decimal?       @db.Decimal(12, 2) // 4도칼라 양면 단가

  // 인디고 6도칼라 가격
  sixColorSinglePrice    Decimal?       @db.Decimal(12, 2) // 6도칼라 단면 단가
  sixColorDoublePrice    Decimal?       @db.Decimal(12, 2) // 6도칼라 양면 단가

  // 구간별 Nup+면당가격 (nup_page_range용)
  basePages              Int?            // 기본 페이지 수 (예: 30p)
  basePrice              Decimal?        @db.Decimal(12, 2) // 기본 가격 (예: 10000원)
  pricePerPage           Decimal?        @db.Decimal(12, 2) // 1p당 추가 가격 (예: 200원)
  rangePrices            Json?           // 구간별 가격 (예: { "30": 20000, "40": 23000 })

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([productionSettingId])
  @@map("production_setting_prices")
}
